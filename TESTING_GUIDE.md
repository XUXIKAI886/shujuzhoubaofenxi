# 数据周报系统功能测试指南

## 测试概览

本项目已完成全面的功能测试验证，包括表单验证、业务逻辑、API集成、安全性和用户体验等关键功能。

## 自动化测试套件

### 测试覆盖范围

1. **表单验证测试** (`__tests__/lib/validations.test.ts`)
   - 店铺信息字段验证
   - 数值类型和范围检查
   - 营业时间格式验证
   - 业务逻辑一致性验证

2. **API客户端测试** (`__tests__/lib/api-client.test.ts`)
   - Gemini API调用功能
   - 错误处理和重试机制
   - 环境配置验证
   - 安全性和超时处理

3. **表单组件测试** (`__tests__/components/form-validation.test.tsx`)
   - 用户输入验证
   - 数据持久化功能
   - 交互体验测试
   - 状态管理验证

4. **安全性测试** (`__tests__/components/security.test.tsx`)
   - XSS攻击防护
   - HTML净化功能
   - 安全下载和打印
   - 内容安全策略

5. **API集成测试** (`__tests__/integration/api-integration.test.ts`)
   - 完整API调用流程
   - 错误场景处理
   - 数据传输验证
   - 边界值测试

6. **端到端用户流程测试** (`__tests__/e2e/user-workflow.test.tsx`)
   - 完整用户操作流程
   - 多步骤表单交互
   - 错误恢复机制
   - 数据持久化验证

### 运行测试命令

```bash
# 安装测试依赖
npm install

# 运行所有测试
npm test

# 运行特定测试套件
npm run test:unit          # 单元测试
npm run test:component     # 组件测试
npm run test:integration   # 集成测试
npm run test:e2e          # 端到端测试
npm run test:security     # 安全性测试

# 开发模式
npm run test:watch        # 监听模式
npm run test:quick        # 快速测试（无覆盖率）

# 生成覆盖率报告
npm run test:coverage
```

## 手动功能测试

### 环境准备

1. 确保安装了所有依赖：
   ```bash
   npm install
   ```

2. 启动开发服务器：
   ```bash
   npm run dev
   ```

3. 访问应用：
   ```
   http://localhost:3000
   ```

### 测试场景

#### 1. 表单验证测试

**测试目标**：验证表单验证规则是否正确工作

**测试步骤**：

1. **空值验证测试**
   - 不填写任何字段，直接点击"下一步"
   - 应该显示所有必填字段的错误提示
   - 验证：店铺名称、经营品类、店铺地址、营业时间的错误信息

2. **字段长度验证测试**
   - 店铺名称输入超过50个字符
   - 地址输入超过200个字符
   - 应该显示相应的长度限制错误

3. **营业时间格式验证测试**
   - 输入错误格式：`9:00-22:00`（小时应为两位数）
   - 输入错误格式：`09:0-22:00`（分钟应为两位数）
   - 输入错误格式：`09:00 22:00`（缺少连字符）
   - 应该显示格式错误提示

4. **有效数据测试**
   - 填写完整有效的店铺信息
   - 应该能成功进入下一步

#### 2. 业务逻辑测试

**测试目标**：测试数据合理性检查功能

**测试步骤**：

1. **数据一致性验证**
   - 本周数据：曝光人数 100，入店人数 150（错误：入店>曝光）
   - 应该弹出确认对话框提示数据异常

2. **转化率计算验证**
   - 曝光人数 1000，入店人数 150，入店转化率 10%
   - 应该提示转化率计算不准确（实际应为15%）

3. **推广数据验证**
   - 启用推广数据
   - 推广曝光量 100，推广进店量 150（错误：进店>曝光）
   - 应该提示推广数据异常

4. **正常数据流程**
   - 输入合理的数据（入店≤曝光，下单≤入店）
   - 应该能正常进入API配置步骤

#### 3. API集成测试

**测试目标**：验证Gemini API调用是否正常

**测试步骤**：

1. **无效API密钥测试**
   - 输入无效的API密钥
   - 点击"生成报告"
   - 应该显示API错误信息

2. **空API密钥测试**
   - 不输入API密钥
   - "生成报告"按钮应该被禁用

3. **网络错误模拟**
   - 断开网络连接
   - 尝试生成报告
   - 应该显示网络错误提示

4. **成功场景测试**（需要有效API密钥）
   - 输入有效的Gemini API密钥
   - 点击"生成报告"
   - 应该显示"正在生成报告..."加载状态
   - 成功后应该显示生成的HTML报告

#### 4. 安全性测试

**测试目标**：验证HTML净化功能是否防止XSS

**测试步骤**：

1. **恶意脚本注入测试**
   - 在店铺名称中输入：`<script>alert('XSS')</script>`
   - 完成整个流程生成报告
   - 查看报告内容，脚本标签应该被清理

2. **HTML标签测试**
   - 输入包含HTML标签的内容
   - 报告中应该只保留安全的HTML标签

3. **下载安全测试**
   - 下载生成的报告
   - 打开下载的HTML文件
   - 确认内容已被净化，无恶意代码

4. **打印功能测试**
   - 使用打印功能
   - 确认打印内容安全

#### 5. 用户体验测试

**测试目标**：测试数据持久化、错误提示、加载状态

**测试步骤**：

1. **数据持久化测试**
   - 填写部分表单数据
   - 刷新页面
   - 数据应该被恢复

2. **数据清空功能测试**
   - 点击"清空数据"按钮
   - 应该弹出确认对话框
   - 确认后所有数据应该被清空

3. **进度指示器测试**
   - 观察每个步骤的进度指示器
   - 当前步骤应该高亮显示
   - 已完成步骤应该显示为完成状态

4. **回退功能测试**
   - 在API配置步骤点击"上一步"
   - 应该返回数据输入步骤
   - 之前填写的数据应该保留

5. **错误恢复测试**
   - 在API调用失败后
   - 应该返回API配置步骤
   - 可以重新尝试

#### 6. 环境配置测试

**测试目标**：验证环境变量配置是否正确

**测试步骤**：

1. **默认配置测试**
   - 不设置环境变量
   - 应用应该使用默认的API配置

2. **自定义配置测试**（可选）
   - 设置自定义API_BASE_URL和API_MODEL
   - 验证应用使用自定义配置

## 测试数据示例

### 有效的测试数据

```javascript
// 店铺信息
{
  shopName: "王记拉面馆",
  category: "中式快餐",
  address: "北京市朝阳区建国路88号SOHO现代城B座1层",
  businessHours: "10:00-22:00"
}

// 运营数据
{
  thisWeek: {
    exposureCount: 2500,
    visitCount: 380,
    visitConversionRate: 15.2,
    orderConversionRate: 25.8,
    orderCount: 98,
    repurchaseRate: 32.1
  },
  lastWeek: {
    exposureCount: 2200,
    visitCount: 330,
    visitConversionRate: 15.0,
    orderConversionRate: 24.2,
    orderCount: 80,
    repurchaseRate: 28.7
  }
}

// 推广数据（可选）
{
  thisWeek: {
    cost: 890.50,
    exposureCount: 5000,
    visitCount: 250,
    visitRate: 5.0,
    costPerVisit: 3.56
  },
  lastWeek: {
    cost: 750.30,
    exposureCount: 4500,
    visitCount: 220,
    visitRate: 4.9,
    costPerVisit: 3.41
  }
}
```

### 异常测试数据

```javascript
// 数据一致性错误示例
{
  exposureCount: 100,
  visitCount: 150,  // 错误：入店人数 > 曝光人数
  orderCount: 200   // 错误：下单人数 > 入店人数
}

// 转化率计算错误示例
{
  exposureCount: 1000,
  visitCount: 150,
  visitConversionRate: 10  // 错误：实际应为15%
}
```

## 预期测试结果

### 通过标准

1. **功能完整性**
   - 所有表单验证规则正确工作
   - 业务逻辑验证准确
   - API调用功能正常（有效密钥时）
   - 报告生成和显示正确

2. **安全性**
   - XSS攻击防护有效
   - HTML内容正确净化
   - 文件下载和打印安全

3. **用户体验**
   - 数据持久化功能正常
   - 错误提示清晰准确
   - 加载状态显示及时
   - 界面响应流畅

4. **错误处理**
   - 网络错误处理妥当
   - API错误信息明确
   - 用户操作错误有引导

## 问题排查

### 常见问题

1. **API调用失败**
   - 检查API密钥是否有效
   - 确认网络连接正常
   - 验证API服务是否可用

2. **表单验证异常**
   - 确认输入数据格式
   - 检查浏览器控制台错误
   - 验证JavaScript是否正常加载

3. **数据持久化问题**
   - 检查浏览器是否支持localStorage
   - 确认浏览器没有禁用本地存储
   - 清理浏览器缓存后重试

4. **页面显示异常**
   - 检查CSS样式是否正确加载
   - 验证Tailwind CSS配置
   - 确认React组件正常渲染

## 测试报告模板

### 测试执行记录

```
测试日期：[日期]
测试人员：[姓名]
测试环境：[浏览器版本/操作系统]

测试结果：
□ 表单验证测试 - 通过/失败
□ 业务逻辑测试 - 通过/失败
□ API集成测试 - 通过/失败
□ 安全性测试 - 通过/失败
□ 用户体验测试 - 通过/失败
□ 环境配置测试 - 通过/失败

发现问题：
1. [问题描述]
2. [问题描述]

建议改进：
1. [改进建议]
2. [改进建议]
```

## 总结

本测试指南提供了全面的功能验证方法，确保数据统计周报系统的所有核心功能正常工作。通过自动化测试和手动测试相结合的方式，可以全面验证系统的可靠性、安全性和用户体验。